<?php /** @noinspection ALL */

namespace App\Http\Controllers\Payment;

use App\Entities\Order;
use App\Services\AppManager;
use Dingo\Api\Http\Request as DingoRequest;
use Illuminate\Http\Request as LumenRequest;
use Dingo\Api\Http\Response;
use App\Http\Controllers\Payment\PaymentController as Controller;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Session;
use Illuminate\View\View;
use Payment\NotifyContext;
use App\Entities\PaymentSigned as AliPaymentSigned;
use App\Transformers\Api\PaymentSignedTransformer as AliPaymentSignedTransformer;
use App\Entities\Shop;
use App\Entities\Customer;


class AliPaymentController extends Controller
{
    /**
     * 聚合支付
     * @param DingoRequesti|LumenRequest $request
     * @return Response|View|null
     * @throws
     * */
    public function aggregate(LumenRequest $request)
    {
        session()->setId($request->input('token'));
        session()->start();
        /**
         * @var Shop $shop
         * */
        $shop = session('shop', null);

        /**
         * @var Customer $customer
         * */
        $customer = session('customer', null);

        $order = [
            'type' => Order::OFF_LINE_PAY,
            'pay_type' => Order::ALI_PAY,
            'open_id' => $customer->platformOpenId,
            'app_id' => $customer->appId,
            'wechat_app_id' => $customer->platformAppId,
            'customer_id' => $customer->id,
            'member_id'   => $customer->memberId,
            'ip' => $request->getClientIp(),
            'shop_id' => $shop->id
        ];
        $request->merge($order);
        $order = $this->app->make('order.builder')->setInput($request->all())->handle();
        $charge = app('ali.payment.aggregate');
        $order = $this->preOrder($order->buildAliAggregatePaymentOrder(), $charge);
        return $this->response()->item( new AliPaymentSigned($order),
            new AliPaymentSignedTransformer());
    }

    public function aggregatePage(LumenRequest $request)
    {
        $paymentApi = paymentApiUriGenerator('/ali/aggregate');
        $accept = "application/vnd.pinehub.v0.0.1+json";
        //$userId = $request->input('customer_id', null);
        $apiUrl = $paymentApi.'?token='.session()->getId();
        $shop = $this->shopModel->find((int)$request->input('shop_id'));
        session(['shop' => $shop]);
        try{
            return view('payment.aggregate.alipay')->with([
                'paymentApi' => $apiUrl,
                'accept' => $accept,
            ]);
        }catch (\Exception $exception){
            return view('payment.aggregate.alipay')->with([
                'paymentApi' => $apiUrl,
                'accept' => $accept,
            ]);
        }
    }


    public function notify(string $type = 'ali', NotifyContext $notify = null)
    {
        $notify = $this->app->make('payment.ali.notify');
        parent::notify($type, $notify); // TODO: Change the autogenerated stub
    }
}
